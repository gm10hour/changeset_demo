# .github/workflows/release.yml
name: Release

on:
  push:
    branches: [main, master]
  # ç§»é™¤ pull_request è§¦å‘ï¼Œå› ä¸º Changesets åœ¨ PR ä¸­è¿è¡Œä¼šæœ‰é—®é¢˜
  workflow_dispatch:

# ä¸ºæ•´ä¸ªå·¥ä½œæµè®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: write
  packages: write  # æ·»åŠ  packages æƒé™ç”¨äºå‘å¸ƒ npm åŒ…

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´å†å²ï¼ŒChangeset éœ€è¦
          fetch-depth: 0
          # ä½¿ç”¨æœ‰æƒé™çš„ token
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug - Check files
        run: |
          echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶ç»“æ„:"
          ls -la
          echo ""
          echo "ğŸ“„ æ£€æŸ¥ package-lock.json:"
          if [ -f package-lock.json ]; then
            echo "âœ… package-lock.json å­˜åœ¨"
            echo "   æ–‡ä»¶å¤§å°: $(wc -l < package-lock.json) è¡Œ"
          else
            echo "âŒ package-lock.json ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ npm install"
          fi
          echo ""
          echo "ğŸ“„ æ£€æŸ¥ package.json:"
          cat package.json | grep -E '"(name|version|scripts)"'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # å¯ç”¨ npm ç¼“å­˜

      - name: Install Dependencies
        run: |
          # æ™ºèƒ½å®‰è£…ï¼šå¦‚æœæœ‰ lock æ–‡ä»¶ç”¨ ciï¼Œæ²¡æœ‰åˆ™ç”¨ install
          if [ -f package-lock.json ]; then
            echo "âœ… æ£€æµ‹åˆ° package-lock.jsonï¼Œä½¿ç”¨ npm ci"
            npm ci
          else
            echo "âš ï¸  æœªæ‰¾åˆ° package-lock.jsonï¼Œä½¿ç”¨ npm install"
            npm install
            
            # å¯é€‰ï¼šå°†ç”Ÿæˆçš„ lock æ–‡ä»¶æäº¤åˆ°ä»“åº“
            echo "ğŸ”§ å°† package-lock.json æ·»åŠ åˆ°æš‚å­˜åŒº..."
            git config --global user.name 'github-actions[bot]'
            git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
            git add package-lock.json || echo "æ—  package-lock.json å¯æ·»åŠ "
            git commit -m "chore: add package-lock.json" || echo "æ— å˜æ›´å¯æäº¤"
            git push || echo "æ¨é€å¤±è´¥æˆ–æ— å˜æ›´"
          fi
          
          # éªŒè¯å®‰è£…æˆåŠŸ
          echo "ğŸ“¦ å®‰è£…çš„ä¾èµ–:"
          npm list --depth=0 || echo "npm list å¤±è´¥"

      - name: Build package (if needed)
        if: false  # é»˜è®¤å…³é—­ï¼Œå¦‚æœä½ çš„é¡¹ç›®éœ€è¦æ„å»ºåˆ™æ”¹ä¸º true
        run: |
          if [ -f package.json ] && grep -q '"build"' package.json; then
            echo "ğŸ—ï¸  è¿è¡Œæ„å»ºè„šæœ¬..."
            npm run build
          else
            echo "ğŸ“¦ æ— æ„å»ºè„šæœ¬ï¼Œè·³è¿‡æ„å»º"
          fi

      - name: Run tests (if needed)
        if: false  # é»˜è®¤å…³é—­ï¼Œå¦‚æœä½ çš„é¡¹ç›®æœ‰æµ‹è¯•åˆ™æ”¹ä¸º true
        run: |
          if [ -f package.json ] && grep -q '"test"' package.json; then
            echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
            npm test
          else
            echo "ğŸ§ª æ— æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•"
          fi

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          # å‘å¸ƒå‘½ä»¤ - ç¡®ä¿ package.json ä¸­æœ‰ "release" è„šæœ¬
          publish: npx changeset publish
          # ç‰ˆæœ¬æ›´æ–°å‘½ä»¤
          version: npx changeset version
          # æäº¤ä¿¡æ¯
          commit: '[ci] release packages'
          # PR æ ‡é¢˜
          title: 'chore: version packages'
          # PR æ­£æ–‡
          body: 'This PR was opened by the Changesets GitHub action. When you're ready, merge it to publish.'
          # åˆ†æ”¯åç§°æ¨¡å¼
          branch: 'changeset-release/main'
          # è‡ªåŠ¨åˆ›å»º GitHub Release
          createGithubReleases: false  # å…ˆè®¾ä¸º falseï¼Œè°ƒè¯•æˆåŠŸåå†å¼€å¯
          # æ˜¯å¦è‡ªåŠ¨åˆå¹¶
          autoMerge: false
        env:
          # å¿…é¡»ä½¿ç”¨ GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # npm å‘å¸ƒ token - ä½¿ç”¨æ­£ç¡®çš„ secret åç§°
          NPM_TOKEN: ${{ secrets.NPM_TOKEN || secrets.CHANGSET_DEMO }}
          
      - name: Debug - Check Changeset output
        if: always()
        run: |
          echo "ğŸ”„ Changeset æ‰§è¡ŒçŠ¶æ€: ${{ steps.changesets.outcome }}"
          echo "ğŸ“Š å·¥ä½œæµä¿¡æ¯:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"